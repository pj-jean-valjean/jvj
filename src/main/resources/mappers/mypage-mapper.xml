<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mypageMapper">

	<resultMap type="Coupon" id="coupon_rm">
		<id property="couponNo" column="COUPON_NO"/>
		<result property="couponName" column="COUPON_NM"/>
		<result property="discountPer" column="DISCOUNT_PER"/>
		<result property="provideDate" column="PROVIDE_DT"/>
		<result property="expireDate" column="EXPIRE_DT"/>
		<result property="couponStatusCode" column="COU_STATUS_CD"/>
		<result property="couponStatusName" column="COU_STATUS_NM"/>
		<result property="memberNo" column="MEMBER_NO"/>
	</resultMap>
	
	<resultMap type="CouponStatus" id="couponStatus_rm">
		<id property="couponStatusCode" column="CATEGORY_CD"/>
		<result property="couponStatusName" column="COU_STATUS_NM"/>
	</resultMap>
	
	<resultMap type="Like" id="like_rm">
		<id property="productNo" column="PRODUCT_NO"/>
		<result property="memberNo" column="MEMBER_NO"/>
		
		<result property="productName" column="PRODUCT_NM"/>
		<result property="productPrice" column="PRODUCT_PRICE"/>
		<result property="productCode" column="PRODUCT_CD"/>
				
		<result property="productImageNo" column="PRODUCT_IMG_NO"/>
		<result property="productImagePath" column="PRODUCT_IMG_PATH"/>
		<result property="productImageName" column="PRODUCT_IMG_NAME"/>
		<result property="productImageLevel" column="PRODUCT_IMG_LEVEL"/>
	</resultMap>
	
	
	 <resultMap type="Member" id="member_rm">
	 	<id property="memberNo" column="MEMBER_NO"/>
	 	
	 	<result property="memberEmail" 			column="MEMBER_EMAIL"/>
	 	<result property="memberPw" 			column="MEMBER_PW"/>
	 	<result property="memberNickname" 		column="MEMBER_NICKNAME"/>
	 	<result property="memberName" 			column="MEMBER_NAME"/>
	 	<result property="memberPhone" 			column="MEMBER_PHONE"/>
	 	<result property="memberAddress" 		column="MEMBER_ADDR"/>
	 	<result property="enrollDate" 			column="ENROLL_DT"/>
	 	<result property="statusCode" 			column="STATUS_CD"/>
	 	<result property="gradeCode" 			column="GRADE_CD"/>
	 	<result property="service" 				column="MEMBER_SERVICE"/>
	 	<result property="memberId" 			column="MEMBER_ID"/>
	 </resultMap>



	<!-- 전체 쿠폰 조회 -->
	<select id="getCouponCount" resultType="_int">
		SELECT COUNT(*) FROM COUPON 
	</select>
	
	<select id="selectCouponList" resultMap="coupon_rm">
		SELECT COUPON_NO, COUPON_NM, (DISCOUNT_PER *100), PROVIDE_DT, EXPIRE_DT, COUPON.COU_STATUS_CD, COU_STATUS_NM, MEMBER_NO
		FROM COUPON
		JOIN COUPON_STATUS ON(COUPON.COU_STATUS_CD = COUPON_STATUS.COU_STATUS_CD)
		WHERE MEMBER_NO = #{memberNo}
		ORDER BY COUPON_NO DESC
	</select>
	
	<!-- 쿠폰 카테고리 조회 -->
	<select id="statusCategory" resultMap="couponStatus_rm">
		SELECT * FROM COUPON_STATUS 
	</select>
	
	
	<!-- 전체 좋아요 조회 -->
	<select id="getLikeCount" resultType="_int">
		SELECT COUNT(*) FROM "LIKE"  
	</select>
	<!-- 회원 목록 좋아요 조회 -->
	<select id="getLikeList" resultMap="like_rm">
		SELECT PRODUCT_NO, MEMBER_NO, 
		PRODUCT_NM, PRODUCT_PRICE, PRODUCT_CD, 
		PRODUCT_IMG_NO, PRODUCT_IMG_PATH, PRODUCT_IMG_NAME, PRODUCT_IMG_LEVEL
		FROM "LIKE"
		LEFT JOIN PRODUCT USING(PRODUCT_NO)
		LEFT JOIN PRODUCT_IMG USING(PRODUCT_NO)
		WHERE MEMBER_NO = #{memberNo}
	</select>
	<!-- 좋아요 취소 -->
	<delete id="cancleLike" parameterType="_int">
		DELETE FROM "LIKE"
		WHERE MEMBER_NO = #{memberNo}
        AND PRODUCT_NO = #{productNo}
	</delete>
	
	<!-- 회원 번호 수정-->
	<update id="memberUpdate" parameterType="Member">
	
		<choose>
		
			<when test="service == 'naver'">
				UPDATE MEMBER SET 
				MEMBER_PHONE = #{memberPhone}, MEMBER_ADDR = #{memberAddress} 
				WHERE MEMBER_NO = #{memberNo}
				AND MEMBER_SERVICE = #{service}
			</when>
			
			<when test="service == 'kakao'">
				UPDATE MEMBER SET 
				MEMBER_NAME = #{memberName}, MEMBER_PHONE = #{memberPhone}, MEMBER_ADDR = #{memberAddress} 
				WHERE MEMBER_NO = #{memberNo}
				AND MEMBER_SERVICE = #{service}
			</when>
			
			<otherwise>
				UPDATE MEMBER SET 
				MEMBER_NICKNAME = #{memberNickname}, MEMBER_PHONE = #{memberPhone}, MEMBER_ADDR = #{memberAddress} 
				WHERE MEMBER_NO = #{memberNo}
			</otherwise>
				
		</choose>
	</update>
	
	
	<!-- 암호화된 비밀번호 조회 -->
	<select id="selectDecodePw" resultType="string">
		SELECT MEMBER_PW 
		FROM MEMBER 
		WHERE MEMBER_NO = #{memberNo}
		AND MEMBER_SERVICE IS NULL
	</select>
	
	<update id="modifyPassword" parameterType="map">
		UPDATE MEMBER SET 
		MEMBER_PW = #{modifyPw}
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<update id="secession" parameterType="_int">
		UPDATE MEMBER SET
		STATUS_CD = 2
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
</mapper>
